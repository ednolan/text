// Copyright (C) 2020 T. Zachary Laine
//
// Distributed under the Boost Software License, Version 1.0. (See
// accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt)

// Warning! This file is autogenerated.
#include <boost/text/grapheme_iterator.hpp>
#include <boost/text/transcode_iterator.hpp>

#include <gtest/gtest.h>

#include <algorithm>



TEST(grapheme, iterator_12_0_fwd)
{
    // ÷ 0378 ÷ 0378 ÷	
    // ÷ [0.2] <reserved-0378> (Other) ÷ [999.0] <reserved-0378> (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0378, 0x0378 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 2);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_0_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0378, 0x0378 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 2, cps + 2);

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 2);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_0_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0378, 0x0378 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 2);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 2);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 2);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_0_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0378, 0x0378 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 2, cps + 2);

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 2);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_0_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0378, 0x0378 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 2),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 2, cps + 2),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[1]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[1]);

        ++it;

        EXPECT_EQ(*it.base(), cps[1]);
        EXPECT_EQ(*it->begin(), cps[1]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_1_fwd)
{
    // ÷ 0378 × 0308 ÷ 0378 ÷	
    // ÷ [0.2] <reserved-0378> (Other) × [9.0] COMBINING DIAERESIS (Extend_ExtCccZwj) ÷ [999.0] <reserved-0378> (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0378, 0x0308, 0x0378 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_1_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0378, 0x0308, 0x0378 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_1_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0378, 0x0308, 0x0378 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_1_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0378, 0x0308, 0x0378 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_1_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0378, 0x0308, 0x0378 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_2_fwd)
{
    // ÷ 000D × 000A ÷ 0061 ÷ 000A ÷ 0308 ÷	
    // ÷ [0.2] <CARRIAGE RETURN (CR)> (CR) × [3.0] <LINE FEED (LF)> (LF) ÷ [4.0] LATIN SMALL LETTER A (Other) ÷ [5.0] <LINE FEED (LF)> (LF) ÷ [4.0] COMBINING DIAERESIS (Extend_ExtCccZwj) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x000D, 0x000A, 0x0061, 0x000A, 0x0308 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 5);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_2_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x000D, 0x000A, 0x0061, 0x000A, 0x0308 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 5, cps + 5);

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_2_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x000D, 0x000A, 0x0061, 0x000A, 0x0308 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 5);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_2_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x000D, 0x000A, 0x0061, 0x000A, 0x0308 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 5, cps + 5);

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_2_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x000D, 0x000A, 0x0061, 0x000A, 0x0308 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 5),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 5, cps + 5),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(*it->end(), cps[3]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(*it.base(), cps[3]);
        EXPECT_EQ(*it->begin(), cps[3]);
        EXPECT_EQ(*it->end(), cps[4]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[4]);

        ++it;

        EXPECT_EQ(*it.base(), cps[4]);
        EXPECT_EQ(*it->begin(), cps[4]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[4]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[4]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[5]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[5]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_3_fwd)
{
    // ÷ 0061 × 0308 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) × [9.0] COMBINING DIAERESIS (Extend_ExtCccZwj) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x0308 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 2);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_3_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x0308 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 2, cps + 2);

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_3_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x0308 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 2);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_3_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x0308 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 2, cps + 2);

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_3_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x0308 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 2),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 2, cps + 2),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_4_fwd)
{
    // ÷ 0020 × 200D ÷ 0646 ÷	
    // ÷ [0.2] SPACE (Other) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) ÷ [999.0] ARABIC LETTER NOON (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0020, 0x200D, 0x0646 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_4_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0020, 0x200D, 0x0646 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_4_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0020, 0x200D, 0x0646 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_4_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0020, 0x200D, 0x0646 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_4_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0020, 0x200D, 0x0646 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_5_fwd)
{
    // ÷ 0646 × 200D ÷ 0020 ÷	
    // ÷ [0.2] ARABIC LETTER NOON (Other) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) ÷ [999.0] SPACE (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0646, 0x200D, 0x0020 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_5_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0646, 0x200D, 0x0020 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_5_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0646, 0x200D, 0x0020 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_5_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0646, 0x200D, 0x0020 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_5_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0646, 0x200D, 0x0020 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_6_fwd)
{
    // ÷ 1100 × 1100 ÷	
    // ÷ [0.2] HANGUL CHOSEONG KIYEOK (L) × [6.0] HANGUL CHOSEONG KIYEOK (L) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x1100, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 2);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_6_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x1100, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 2, cps + 2);

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_6_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x1100, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 2);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_6_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x1100, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 2, cps + 2);

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_6_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x1100, 0x1100 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 2),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 2, cps + 2),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_7_fwd)
{
    // ÷ AC00 × 11A8 ÷ 1100 ÷	
    // ÷ [0.2] HANGUL SYLLABLE GA (LV) × [7.0] HANGUL JONGSEONG KIYEOK (T) ÷ [999.0] HANGUL CHOSEONG KIYEOK (L) ÷ [0.3]
    {
        uint32_t const cps[] = { 0xAC00, 0x11A8, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_7_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0xAC00, 0x11A8, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_7_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0xAC00, 0x11A8, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_7_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0xAC00, 0x11A8, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_7_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0xAC00, 0x11A8, 0x1100 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_8_fwd)
{
    // ÷ AC01 × 11A8 ÷ 1100 ÷	
    // ÷ [0.2] HANGUL SYLLABLE GAG (LVT) × [8.0] HANGUL JONGSEONG KIYEOK (T) ÷ [999.0] HANGUL CHOSEONG KIYEOK (L) ÷ [0.3]
    {
        uint32_t const cps[] = { 0xAC01, 0x11A8, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_8_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0xAC01, 0x11A8, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_8_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0xAC01, 0x11A8, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_8_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0xAC01, 0x11A8, 0x1100 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_8_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0xAC01, 0x11A8, 0x1100 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_9_fwd)
{
    // ÷ 1F1E6 × 1F1E7 ÷ 1F1E8 ÷ 0062 ÷	
    // ÷ [0.2] REGIONAL INDICATOR SYMBOL LETTER A (RI) × [12.0] REGIONAL INDICATOR SYMBOL LETTER B (RI) ÷ [999.0] REGIONAL INDICATOR SYMBOL LETTER C (RI) ÷ [999.0] LATIN SMALL LETTER B (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 4);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_9_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 4, cps + 4);

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_9_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 4);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_9_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 4, cps + 4);

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_9_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 4),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 4, cps + 4),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(*it->end(), cps[3]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(*it.base(), cps[3]);
        EXPECT_EQ(*it->begin(), cps[3]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[4]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[4]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_10_fwd)
{
    // ÷ 0061 ÷ 1F1E6 × 1F1E7 ÷ 1F1E8 ÷ 0062 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) ÷ [999.0] REGIONAL INDICATOR SYMBOL LETTER A (RI) × [13.0] REGIONAL INDICATOR SYMBOL LETTER B (RI) ÷ [999.0] REGIONAL INDICATOR SYMBOL LETTER C (RI) ÷ [999.0] LATIN SMALL LETTER B (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 5);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_10_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 5, cps + 5);

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_10_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 5);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_10_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 5, cps + 5);

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_10_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x0062 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 5),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 5, cps + 5),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[1]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[1]);

        ++it;

        EXPECT_EQ(*it.base(), cps[1]);
        EXPECT_EQ(*it->begin(), cps[1]);
        EXPECT_EQ(*it->end(), cps[3]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(*it.base(), cps[3]);
        EXPECT_EQ(*it->begin(), cps[3]);
        EXPECT_EQ(*it->end(), cps[4]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[4]);

        ++it;

        EXPECT_EQ(*it.base(), cps[4]);
        EXPECT_EQ(*it->begin(), cps[4]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[4]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[4]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[5]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[5]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_11_fwd)
{
    // ÷ 0061 ÷ 1F1E6 × 1F1E7 × 200D ÷ 1F1E8 ÷ 0062 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) ÷ [999.0] REGIONAL INDICATOR SYMBOL LETTER A (RI) × [13.0] REGIONAL INDICATOR SYMBOL LETTER B (RI) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) ÷ [999.0] REGIONAL INDICATOR SYMBOL LETTER C (RI) ÷ [999.0] LATIN SMALL LETTER B (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x200D, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 6);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_11_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x200D, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 6, cps + 6);

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_11_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x200D, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 6);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_11_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x200D, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 6, cps + 6);

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 4);

        ++it;

        EXPECT_EQ(it.base(), cps + 4);
        EXPECT_EQ((*it).begin(), cps + 4);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_11_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x200D, 0x1F1E8, 0x0062 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 6),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 6, cps + 6),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[1]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[1]);

        ++it;

        EXPECT_EQ(*it.base(), cps[1]);
        EXPECT_EQ(*it->begin(), cps[1]);
        EXPECT_EQ(*it->end(), cps[4]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[4]);

        ++it;

        EXPECT_EQ(*it.base(), cps[4]);
        EXPECT_EQ(*it->begin(), cps[4]);
        EXPECT_EQ(*it->end(), cps[5]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[4]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[4]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[5]);

        ++it;

        EXPECT_EQ(*it.base(), cps[5]);
        EXPECT_EQ(*it->begin(), cps[5]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[5]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[5]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[6]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[6]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_12_fwd)
{
    // ÷ 0061 ÷ 1F1E6 × 200D ÷ 1F1E7 × 1F1E8 ÷ 0062 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) ÷ [999.0] REGIONAL INDICATOR SYMBOL LETTER A (RI) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) ÷ [999.0] REGIONAL INDICATOR SYMBOL LETTER B (RI) × [13.0] REGIONAL INDICATOR SYMBOL LETTER C (RI) ÷ [999.0] LATIN SMALL LETTER B (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x200D, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 6);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_12_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x200D, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 6, cps + 6);

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_12_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x200D, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 6);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_12_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x200D, 0x1F1E7, 0x1F1E8, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 6, cps + 6);

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_12_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x200D, 0x1F1E7, 0x1F1E8, 0x0062 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 6),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 6, cps + 6),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[1]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[1]);

        ++it;

        EXPECT_EQ(*it.base(), cps[1]);
        EXPECT_EQ(*it->begin(), cps[1]);
        EXPECT_EQ(*it->end(), cps[3]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(*it.base(), cps[3]);
        EXPECT_EQ(*it->begin(), cps[3]);
        EXPECT_EQ(*it->end(), cps[5]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[5]);

        ++it;

        EXPECT_EQ(*it.base(), cps[5]);
        EXPECT_EQ(*it->begin(), cps[5]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[5]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[5]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[6]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[6]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_13_fwd)
{
    // ÷ 0061 ÷ 1F1E6 × 1F1E7 ÷ 1F1E8 × 1F1E9 ÷ 0062 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) ÷ [999.0] REGIONAL INDICATOR SYMBOL LETTER A (RI) × [13.0] REGIONAL INDICATOR SYMBOL LETTER B (RI) ÷ [999.0] REGIONAL INDICATOR SYMBOL LETTER C (RI) × [13.0] REGIONAL INDICATOR SYMBOL LETTER D (RI) ÷ [999.0] LATIN SMALL LETTER B (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x1F1E9, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 6);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_13_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x1F1E9, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 6, cps + 6);

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_13_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x1F1E9, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 6);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_13_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x1F1E9, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 6, cps + 6);

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        --it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), cps + 3);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), cps + 5);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_13_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x1F1E6, 0x1F1E7, 0x1F1E8, 0x1F1E9, 0x0062 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 6),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 6, cps + 6),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[1]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[1]);

        ++it;

        EXPECT_EQ(*it.base(), cps[1]);
        EXPECT_EQ(*it->begin(), cps[1]);
        EXPECT_EQ(*it->end(), cps[3]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(*it.base(), cps[3]);
        EXPECT_EQ(*it->begin(), cps[3]);
        EXPECT_EQ(*it->end(), cps[5]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[5]);

        ++it;

        EXPECT_EQ(*it.base(), cps[5]);
        EXPECT_EQ(*it->begin(), cps[5]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[5]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[5]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[6]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[6]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_14_fwd)
{
    // ÷ 0061 × 200D ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x200D };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 2);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_14_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x200D };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 2, cps + 2);

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_14_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x200D };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 2);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_14_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x200D };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 2, cps + 2);

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_14_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x200D };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 2),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 2, cps + 2),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_15_fwd)
{
    // ÷ 0061 × 0308 ÷ 0062 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) × [9.0] COMBINING DIAERESIS (Extend_ExtCccZwj) ÷ [999.0] LATIN SMALL LETTER B (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x0308, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_15_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x0308, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_15_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x0308, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_15_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x0308, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_15_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x0308, 0x0062 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_16_fwd)
{
    // ÷ 0061 × 0903 ÷ 0062 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) × [9.1] DEVANAGARI SIGN VISARGA (SpacingMark) ÷ [999.0] LATIN SMALL LETTER B (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x0903, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_16_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x0903, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_16_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x0903, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_16_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x0903, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_16_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x0903, 0x0062 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_17_fwd)
{
    // ÷ 0061 ÷ 0600 × 0062 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) ÷ [999.0] ARABIC NUMBER SIGN (Prepend) × [9.2] LATIN SMALL LETTER B (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x0600, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_17_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x0600, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_17_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x0600, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);
    }
}
TEST(grapheme, iterator_12_17_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x0600, 0x0062 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 1);

        ++it;

        EXPECT_EQ(it.base(), cps + 1);
        EXPECT_EQ((*it).begin(), cps + 1);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_17_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x0600, 0x0062 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[1]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[1]);

        ++it;

        EXPECT_EQ(*it.base(), cps[1]);
        EXPECT_EQ(*it->begin(), cps[1]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[1]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_18_fwd)
{
    // ÷ 1F476 × 1F3FF ÷ 1F476 ÷	
    // ÷ [0.2] BABY (ExtPict) × [9.0] EMOJI MODIFIER FITZPATRICK TYPE-6 (Extend) ÷ [999.0] BABY (ExtPict) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x1F476 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_18_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x1F476 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_18_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x1F476 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_18_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x1F476 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_18_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x1F476 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_19_fwd)
{
    // ÷ 0061 × 1F3FF ÷ 1F476 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) × [9.0] EMOJI MODIFIER FITZPATRICK TYPE-6 (Extend) ÷ [999.0] BABY (ExtPict) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_19_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_19_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_19_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_19_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_20_fwd)
{
    // ÷ 0061 × 1F3FF ÷ 1F476 × 200D × 1F6D1 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) × [9.0] EMOJI MODIFIER FITZPATRICK TYPE-6 (Extend) ÷ [999.0] BABY (ExtPict) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) × [11.0] OCTAGONAL SIGN (ExtPict) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 5);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_20_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 5, cps + 5);

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_20_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 5);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_20_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 5, cps + 5);

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 5);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 5);

        ++it;

        EXPECT_EQ(it.base(), cps + 5);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_20_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x1F3FF, 0x1F476, 0x200D, 0x1F6D1 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 5),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 5, cps + 5),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[5]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[5]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_21_fwd)
{
    // ÷ 1F476 × 1F3FF × 0308 × 200D × 1F476 × 1F3FF ÷	
    // ÷ [0.2] BABY (ExtPict) × [9.0] EMOJI MODIFIER FITZPATRICK TYPE-6 (Extend) × [9.0] COMBINING DIAERESIS (Extend_ExtCccZwj) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) × [11.0] BABY (ExtPict) × [9.0] EMOJI MODIFIER FITZPATRICK TYPE-6 (Extend) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x0308, 0x200D, 0x1F476, 0x1F3FF };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 6);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_21_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x0308, 0x200D, 0x1F476, 0x1F3FF };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 6, cps + 6);

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 6);
    }
}
TEST(grapheme, iterator_12_21_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x0308, 0x200D, 0x1F476, 0x1F3FF };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 6);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 6);
    }
}
TEST(grapheme, iterator_12_21_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x0308, 0x200D, 0x1F476, 0x1F3FF };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 6, cps + 6);

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 6);

        ++it;

        EXPECT_EQ(it.base(), cps + 6);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_21_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x1F476, 0x1F3FF, 0x0308, 0x200D, 0x1F476, 0x1F3FF };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 6),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 6, cps + 6),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[6]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[6]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_22_fwd)
{
    // ÷ 1F6D1 × 200D × 1F6D1 ÷	
    // ÷ [0.2] OCTAGONAL SIGN (ExtPict) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) × [11.0] OCTAGONAL SIGN (ExtPict) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x1F6D1, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_22_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x1F6D1, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);
    }
}
TEST(grapheme, iterator_12_22_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x1F6D1, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);
    }
}
TEST(grapheme, iterator_12_22_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x1F6D1, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_22_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x1F6D1, 0x200D, 0x1F6D1 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_23_fwd)
{
    // ÷ 0061 × 200D ÷ 1F6D1 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) ÷ [999.0] OCTAGONAL SIGN (ExtPict) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_23_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_23_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_23_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x200D, 0x1F6D1 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_23_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x200D, 0x1F6D1 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_24_fwd)
{
    // ÷ 2701 × 200D × 2701 ÷	
    // ÷ [0.2] UPPER BLADE SCISSORS (Other) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) × [11.0] UPPER BLADE SCISSORS (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x2701, 0x200D, 0x2701 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_24_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x2701, 0x200D, 0x2701 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);
    }
}
TEST(grapheme, iterator_12_24_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x2701, 0x200D, 0x2701 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);
    }
}
TEST(grapheme, iterator_12_24_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x2701, 0x200D, 0x2701 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_24_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x2701, 0x200D, 0x2701 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

TEST(grapheme, iterator_12_25_fwd)
{
    // ÷ 0061 × 200D ÷ 2701 ÷	
    // ÷ [0.2] LATIN SMALL LETTER A (Other) × [9.0] ZERO WIDTH JOINER (ZWJ_ExtCccZwj) ÷ [999.0] UPPER BLADE SCISSORS (Other) ÷ [0.3]
    {
        uint32_t const cps[] = { 0x0061, 0x200D, 0x2701 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_25_rev)
{
    {
        // reverse
        uint32_t const cps[] = { 0x0061, 0x200D, 0x2701 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_25_fab)
{
    {
        // forth and back
        uint32_t const cps[] = { 0x0061, 0x200D, 0x2701 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps, cps + 3);

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);
    }
}
TEST(grapheme, iterator_12_25_baf)
{
    {
        // back and forth
        uint32_t const cps[] = { 0x0061, 0x200D, 0x2701 };
        boost::text::grapheme_iterator<uint32_t const *> it(cps, cps + 3, cps + 3);

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());

        --it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        --it;

        EXPECT_EQ(it.base(), cps + 0);
        EXPECT_EQ((*it).begin(), cps + 0);
        EXPECT_EQ((*it).end(), cps + 2);

        ++it;

        EXPECT_EQ(it.base(), cps + 2);
        EXPECT_EQ((*it).begin(), cps + 2);
        EXPECT_EQ((*it).end(), cps + 3);

        ++it;

        EXPECT_EQ(it.base(), cps + 3);
        EXPECT_EQ((*it).begin(), (*it).end());
    }
}
TEST(grapheme, iterator_12_25_utf8)
{
    {
        // from UTF8
        uint32_t const cps[] = { 0x0061, 0x200D, 0x2701 };
        char cus[1024] = { 0 };
        int cp_indices[1024] = { 0 };

        std::copy(
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps, cps + 3),
            boost::text::utf_32_to_8_iterator<uint32_t const *>(cps, cps + 3, cps + 3),
            cus);

        boost::text::null_sentinel_t sentinel;
        int * index_it = cp_indices;
        for (boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t> it(cus, cus, boost::text::null_sentinel); ; ++it) {
            *index_it++ = it.base() - cus;
            if (it == sentinel)
                break;
        }

        using iter_t = boost::text::utf_8_to_32_iterator<char const *, boost::text::null_sentinel_t>;
        boost::text::grapheme_iterator<iter_t, boost::text::null_sentinel_t> it(
            iter_t{cus, cus, boost::text::null_sentinel}, iter_t{cus, cus, boost::text::null_sentinel}, sentinel);

        EXPECT_EQ(*it.base(), cps[0]);
        EXPECT_EQ(*it->begin(), cps[0]);
        EXPECT_EQ(*it->end(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[0]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[2]);

        ++it;

        EXPECT_EQ(*it.base(), cps[2]);
        EXPECT_EQ(*it->begin(), cps[2]);
        EXPECT_EQ(it.base().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->begin().base(), cus + cp_indices[2]);
        EXPECT_EQ(it->end().base(), cus + cp_indices[3]);

        ++it;

        EXPECT_EQ(it.base().base(), cus + cp_indices[3]);
        EXPECT_EQ(it->begin(), (*it).end());
    }
}

